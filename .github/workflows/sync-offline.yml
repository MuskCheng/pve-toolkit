name: Build Offline Package

on:
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build (ignore version check)'
        required: false
        default: 'false'
        type: boolean
  push:
    paths:
      - 'VERSION'
    branches:
      - master
      - main

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      docker_ver: ${{ steps.docker.outputs.version }}
      docker_ver_clean: ${{ steps.docker.outputs.version_clean }}
      compose_ver: ${{ steps.compose.outputs.version }}
      compose_ver_clean: ${{ steps.compose.outputs.version_clean }}
      lucky_digest: ${{ steps.lucky.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current versions
        id: current
        run: |
          if [[ -f ".github/versions.json" ]]; then
            echo "docker=$(jq -r '.docker' .github/versions.json)" >> $GITHUB_OUTPUT
            echo "compose=$(jq -r '.compose' .github/versions.json)" >> $GITHUB_OUTPUT
            echo "lucky_digest=$(jq -r '.lucky_digest' .github/versions.json)" >> $GITHUB_OUTPUT
          else
            echo "docker=none" >> $GITHUB_OUTPUT
            echo "compose=none" >> $GITHUB_OUTPUT
            echo "lucky_digest=none" >> $GITHUB_OUTPUT
          fi

      - name: Get latest Docker version
        id: docker
        run: |
          DOCKER_VER=$(curl -sL "https://download.docker.com/linux/debian/dists/trixie/stable/binary-amd64/Packages.gz" | \
            gunzip | grep -A10 "^Package: docker-ce$" | grep "^Version:" | head -1 | awk '{print $2}')
          DOCKER_VER_CLEAN=$(echo "$DOCKER_VER" | sed 's/-[0-9]~.*//' | sed 's/^[0-9]*://')
          echo "version=$DOCKER_VER" >> $GITHUB_OUTPUT
          echo "version_clean=$DOCKER_VER_CLEAN" >> $GITHUB_OUTPUT
          echo "Docker version: $DOCKER_VER (clean: $DOCKER_VER_CLEAN)"

      - name: Get latest Docker Compose version
        id: compose
        run: |
          COMPOSE_VER=$(curl -sL "https://download.docker.com/linux/debian/dists/trixie/stable/binary-amd64/Packages.gz" | \
            gunzip | grep -A10 "^Package: docker-compose-plugin$" | grep "^Version:" | head -1 | awk '{print $2}')
          COMPOSE_VER_CLEAN=$(echo "$COMPOSE_VER" | sed 's/-[0-9]~.*//')
          echo "version=$COMPOSE_VER" >> $GITHUB_OUTPUT
          echo "version_clean=$COMPOSE_VER_CLEAN" >> $GITHUB_OUTPUT
          echo "Compose version: $COMPOSE_VER (clean: $COMPOSE_VER_CLEAN)"

      - name: Get latest Lucky V2 digest
        id: lucky
        run: |
          docker pull gdy666/lucky:v2
          LUCKY_DIGEST=$(docker inspect --format='{{.Id}}' gdy666/lucky:v2)
          echo "digest=$LUCKY_DIGEST" >> $GITHUB_OUTPUT
          echo "Lucky digest: ${LUCKY_DIGEST:0:20}..."

      - name: Check if build needed
        id: check
        run: |
          CURRENT_DOCKER="${{ steps.current.outputs.docker }}"
          CURRENT_COMPOSE="${{ steps.current.outputs.compose }}"
          CURRENT_LUCKY="${{ steps.current.outputs.lucky_digest }}"
          
          NEW_DOCKER="${{ steps.docker.outputs.version }}"
          NEW_DOCKER_CLEAN="${{ steps.docker.outputs.version_clean }}"
          NEW_COMPOSE="${{ steps.compose.outputs.version }}"
          NEW_COMPOSE_CLEAN="${{ steps.compose.outputs.version_clean }}"
          NEW_LUCKY="${{ steps.lucky.outputs.digest }}"
          
          FORCE="${{ github.event.inputs.force_build }}"
          
          echo "## Version Comparison" | tee -a $GITHUB_STEP_SUMMARY
          echo "| Component | Current | Latest |" | tee -a $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" | tee -a $GITHUB_STEP_SUMMARY
          echo "| Docker | $CURRENT_DOCKER | $NEW_DOCKER_CLEAN |" | tee -a $GITHUB_STEP_SUMMARY
          echo "| Compose | $CURRENT_COMPOSE | $NEW_COMPOSE_CLEAN |" | tee -a $GITHUB_STEP_SUMMARY
          echo "| Lucky | ${CURRENT_LUCKY:0:12}... | ${NEW_LUCKY:0:12}... |" | tee -a $GITHUB_STEP_SUMMARY
          
          SHOULD_BUILD="false"
          
          if [[ "$FORCE" == "true" ]]; then
            echo "âš¡ Force build mode" | tee -a $GITHUB_STEP_SUMMARY
            SHOULD_BUILD="true"
          elif [[ "$CURRENT_DOCKER" != "$NEW_DOCKER_CLEAN" && "$NEW_DOCKER_CLEAN" != "" ]]; then
            echo "ðŸ†• Docker updated" | tee -a $GITHUB_STEP_SUMMARY
            SHOULD_BUILD="true"
          elif [[ "$CURRENT_COMPOSE" != "$NEW_COMPOSE_CLEAN" && "$NEW_COMPOSE_CLEAN" != "" ]]; then
            echo "ðŸ†• Compose updated" | tee -a $GITHUB_STEP_SUMMARY
            SHOULD_BUILD="true"
          elif [[ "$CURRENT_LUCKY" != "$NEW_LUCKY" && "$NEW_LUCKY" != "" ]]; then
            echo "ðŸ†• Lucky updated" | tee -a $GITHUB_STEP_SUMMARY
            SHOULD_BUILD="true"
          else
            echo "âœ… All components are up to date" | tee -a $GITHUB_STEP_SUMMARY
          fi
          
          echo "should_build=$SHOULD_BUILD" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: needs.check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          DOCKER_VER="${{ needs.check.outputs.docker_ver }}"
          DOCKER_VER_CLEAN="${{ needs.check.outputs.docker_ver_clean }}"
          COMPOSE_VER="${{ needs.check.outputs.compose_ver }}"
          COMPOSE_VER_CLEAN="${{ needs.check.outputs.compose_ver_clean }}"
          TOOL_VERSION=$(cat VERSION | tr -d '\n' | tr -d '\r' | sed 's/^V//')
          BUILD_DATE=$(date '+%Y-%m-%d')
          
          echo "DOCKER_VER=$DOCKER_VER" >> $GITHUB_ENV
          echo "DOCKER_VER_CLEAN=$DOCKER_VER_CLEAN" >> $GITHUB_ENV
          echo "COMPOSE_VER=$COMPOSE_VER" >> $GITHUB_ENV
          echo "COMPOSE_VER_CLEAN=$COMPOSE_VER_CLEAN" >> $GITHUB_ENV
          echo "TOOL_VERSION=$TOOL_VERSION" >> $GITHUB_ENV
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          
          mkdir -p offline/docker offline/images

      - name: Get containerd version
        id: containerd
        run: |
          PKG_INFO=$(curl -sL "https://download.docker.com/linux/debian/dists/trixie/stable/binary-amd64/Packages.gz" | \
            gunzip | grep -A20 "^Package: containerd.io$" | head -20)
          CONTAINERD_VER=$(echo "$PKG_INFO" | grep "^Version:" | head -1 | awk '{print $2}')
          CONTAINERD_FILE=$(echo "$PKG_INFO" | grep "^Filename:" | head -1 | awk '{print $2}')
          echo "version=$CONTAINERD_VER" >> $GITHUB_OUTPUT
          echo "filename=$CONTAINERD_FILE" >> $GITHUB_OUTPUT
          echo "containerd version: $CONTAINERD_VER"
          echo "containerd file: $CONTAINERD_FILE"

      - name: Get buildx version
        id: buildx
        run: |
          PKG_INFO=$(curl -sL "https://download.docker.com/linux/debian/dists/trixie/stable/binary-amd64/Packages.gz" | \
            gunzip | grep -A20 "^Package: docker-buildx-plugin$" | head -20)
          BUILDX_VER=$(echo "$PKG_INFO" | grep "^Version:" | head -1 | awk '{print $2}')
          BUILDX_FILE=$(echo "$PKG_INFO" | grep "^Filename:" | head -1 | awk '{print $2}')
          echo "version=$BUILDX_VER" >> $GITHUB_OUTPUT
          echo "filename=$BUILDX_FILE" >> $GITHUB_OUTPUT
          echo "buildx version: $BUILDX_VER"
          echo "buildx file: $BUILDX_FILE"

      - name: Get docker-ce filename
        id: docker-ce
        run: |
          PKG_INFO=$(curl -sL "https://download.docker.com/linux/debian/dists/trixie/stable/binary-amd64/Packages.gz" | \
            gunzip | grep -A20 "^Package: docker-ce$" | head -20)
          DOCKER_CE_FILE=$(echo "$PKG_INFO" | grep "^Filename:" | head -1 | awk '{print $2}')
          echo "filename=$DOCKER_CE_FILE" >> $GITHUB_OUTPUT
          echo "docker-ce file: $DOCKER_CE_FILE"

      - name: Get docker-ce-cli filename
        id: docker-ce-cli
        run: |
          PKG_INFO=$(curl -sL "https://download.docker.com/linux/debian/dists/trixie/stable/binary-amd64/Packages.gz" | \
            gunzip | grep -A20 "^Package: docker-ce-cli$" | head -20)
          DOCKER_CLI_FILE=$(echo "$PKG_INFO" | grep "^Filename:" | head -1 | awk '{print $2}')
          echo "filename=$DOCKER_CLI_FILE" >> $GITHUB_OUTPUT
          echo "docker-ce-cli file: $DOCKER_CLI_FILE"

      - name: Get docker-compose-plugin filename
        id: compose-plugin
        run: |
          PKG_INFO=$(curl -sL "https://download.docker.com/linux/debian/dists/trixie/stable/binary-amd64/Packages.gz" | \
            gunzip | grep -A20 "^Package: docker-compose-plugin$" | head -20)
          COMPOSE_FILE=$(echo "$PKG_INFO" | grep "^Filename:" | head -1 | awk '{print $2}')
          echo "filename=$COMPOSE_FILE" >> $GITHUB_OUTPUT
          echo "compose-plugin file: $COMPOSE_FILE"

      - name: Download Docker packages
        run: |
          CONTAINERD_FILE="${{ steps.containerd.outputs.filename }}"
          BUILDX_FILE="${{ steps.buildx.outputs.filename }}"
          DOCKER_CE_FILE="${{ steps.docker-ce.outputs.filename }}"
          DOCKER_CLI_FILE="${{ steps.docker-ce-cli.outputs.filename }}"
          COMPOSE_FILE="${{ steps.compose-plugin.outputs.filename }}"
          
          echo "ðŸ“¦ Downloading Docker packages..."
          echo "  Docker: ${DOCKER_VER_CLEAN}"
          echo "  Compose: ${COMPOSE_VER_CLEAN}"
          
          curl -fSL -o offline/docker/containerd.io.deb \
            "https://download.docker.com/linux/debian/${CONTAINERD_FILE}"
          
          curl -fSL -o offline/docker/docker-ce.deb \
            "https://download.docker.com/linux/debian/${DOCKER_CE_FILE}"
          
          curl -fSL -o offline/docker/docker-ce-cli.deb \
            "https://download.docker.com/linux/debian/${DOCKER_CLI_FILE}"
          
          curl -fSL -o offline/docker/docker-buildx-plugin.deb \
            "https://download.docker.com/linux/debian/${BUILDX_FILE}"
          
          curl -fSL -o offline/docker/docker-compose-plugin.deb \
            "https://download.docker.com/linux/debian/${COMPOSE_FILE}"
          
          echo "âœ… Downloads complete"
          ls -lh offline/docker/

      - name: Pull and export Lucky V2 image
        run: |
          echo "ðŸ“¥ Pulling Lucky V2 image..."
          docker pull gdy666/lucky:v2
          docker save -o offline/images/lucky.tar gdy666/lucky:v2
          
          LUCKY_SIZE=$(du -h offline/images/lucky.tar | cut -f1)
          echo "LUCKY_SIZE=$LUCKY_SIZE" >> $GITHUB_ENV
          echo "âœ… Lucky V2 image saved ($LUCKY_SIZE)"

      - name: Create install script
        run: |
          cat > offline/install.sh << 'INSTALL_EOF'
          #!/bin/bash
          #
          # PVE Toolkit Offline Installer
          # Docker + Lucky V2
          # 
          # Requirements: PVE 9.1+ / Debian 13 (Trixie) / amd64
          #
          
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          CYAN='\033[0;36m'
          NC='\033[0m'
          
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          LXC_ID="$1"
          
          if [[ -z "$LXC_ID" ]]; then
              echo -e "${RED}Usage: $0 <ContainerID>${NC}"
              echo "Example: $0 100"
              exit 1
          fi
          
          echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
          echo -e "${BLUE}  PVE Toolkit Offline Installer${NC}"
          echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
          echo ""
          echo -e "${CYAN}Target Container: $LXC_ID${NC}"
          echo ""
          
          [[ $EUID -ne 0 ]] && { echo -e "${RED}Error: Root required${NC}"; exit 1; }
          
          if ! pct status "$LXC_ID" &>/dev/null; then
              echo -e "${RED}Error: Container $LXC_ID not found${NC}"
              exit 1
          fi
          
          echo -e "${YELLOW}Checking container system...${NC}"
          OS_INFO=$(pct exec "$LXC_ID" -- cat /etc/os-release 2>/dev/null || echo "")
          if [[ ! "$OS_INFO" =~ "trixie" && ! "$OS_INFO" =~ "Debian GNU/Linux 13" ]]; then
              echo -e "${YELLOW}Warning: Container may not be Debian 13 (Trixie)${NC}"
              echo -ne "Continue? (y/N): "; read confirm
              [[ "$confirm" != "y" && "$confirm" != "Y" ]] && exit 1
          fi
          
          echo -e "${YELLOW}[1/4] Copying files to container...${NC}"
          pct exec "$LXC_ID" -- mkdir -p /tmp/docker /tmp/images
          pct push "$LXC_ID" "$SCRIPT_DIR/docker/" /tmp/docker/ --recursive
          pct push "$LXC_ID" "$SCRIPT_DIR/images/" /tmp/images/ --recursive
          
          echo -e "${YELLOW}[2/4] Installing Docker...${NC}"
          pct exec "$LXC_ID" -- bash -c '
              cd /tmp/docker
              dpkg -i containerd.io.deb 2>/dev/null || true
              dpkg -i docker-ce.deb docker-ce-cli.deb 2>/dev/null || true
              dpkg -i docker-buildx-plugin.deb docker-compose-plugin.deb 2>/dev/null || true
              apt-get install -f -y
          '
          
          echo -e "${YELLOW}[3/4] Starting Docker service...${NC}"
          pct exec "$LXC_ID" -- systemctl enable docker
          pct exec "$LXC_ID" -- systemctl start docker
          
          echo -e "${YELLOW}[4/4] Loading Lucky V2 image...${NC}"
          pct exec "$LXC_ID" -- docker load -i /tmp/images/lucky.tar
          
          pct exec "$LXC_ID" -- rm -rf /tmp/docker /tmp/images
          
          echo ""
          echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
          echo -e "${GREEN}  Installation Complete${NC}"
          echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
          echo ""
          echo -e "${GREEN}Docker:${NC}"
          pct exec "$LXC_ID" -- docker --version
          echo -e "${GREEN}Docker Compose:${NC}"
          pct exec "$LXC_ID" -- docker compose version
          echo ""
          echo -e "${GREEN}Lucky V2 image loaded${NC}"
          echo ""
          echo -e "${CYAN}Start Lucky V2:${NC}"
          echo -e "  docker run -d --name lucky --restart=always --net=host gdy666/lucky:v2"
          echo ""
          INSTALL_EOF
          chmod +x offline/install.sh

      - name: Create README
        run: |
          cat > offline/README.txt << EOF
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            PVE Toolkit Offline Package
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Versions:
            Docker Engine:        v${DOCKER_VER_CLEAN}
            Docker Compose:       v${COMPOSE_VER_CLEAN}
            Lucky V2:             gdy666/lucky:v2
            Build Date:           ${BUILD_DATE}
          
          Requirements:
            - PVE 9.1+
            - Debian 13 (Trixie) container
            - amd64 architecture
          
          Usage:
            tar -xzf pve-toolkit-offline-*.tar.gz
            cd offline
            bash install.sh <ContainerID>
          
          Example:
            tar -xzf pve-toolkit-offline-v${TOOL_VERSION}-amd64.tar.gz
            bash install.sh 100
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF

      - name: Create offline package
        run: |
          echo "ðŸ“¦ Creating offline package..."
          tar -czvf pve-toolkit-offline-v${TOOL_VERSION}-amd64.tar.gz -C offline .
          
          PACKAGE_SIZE=$(du -h pve-toolkit-offline-v${TOOL_VERSION}-amd64.tar.gz | cut -f1)
          echo "PACKAGE_SIZE=$PACKAGE_SIZE" >> $GITHUB_ENV
          echo "âœ… Package size: $PACKAGE_SIZE"
          
          ls -lh pve-toolkit-offline-*.tar.gz

      - name: Update versions.json
        run: |
          mkdir -p .github
          cat > .github/versions.json << EOF
          {
            "docker": "${DOCKER_VER_CLEAN}",
            "compose": "${COMPOSE_VER_CLEAN}",
            "lucky_digest": "${{ needs.check.outputs.lucky_digest }}",
            "build_date": "${BUILD_DATE}"
          }
          EOF
          cat .github/versions.json

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.TOOL_VERSION }}
          name: Release v${{ env.TOOL_VERSION }}
          body: |
            ## ðŸ“¦ Offline Package
            
            | Component | Version |
            |:----------|:--------|
            | Docker Engine | `v${{ env.DOCKER_VER_CLEAN }}` |
            | Docker Compose | `v${{ env.COMPOSE_VER_CLEAN }}` |
            | Lucky V2 | `gdy666/lucky:v2` |
            
            **File:** `pve-toolkit-offline-v${{ env.TOOL_VERSION }}-amd64.tar.gz`
            **Size:** ${{ env.PACKAGE_SIZE }}
            **Build Date:** ${{ env.BUILD_DATE }}
            
            ---
            
            ### ðŸ“¥ Download (China Mirror)
            
            ```
            https://ghproxy.com/https://github.com/MuskCheng/pve-toolkit/releases/download/v${{ env.TOOL_VERSION }}/pve-toolkit-offline-v${{ env.TOOL_VERSION }}-amd64.tar.gz
            ```
            
            ---
            
            ### ðŸš€ Usage
            
            ```bash
            # Extract
            tar -xzf pve-toolkit-offline-v${{ env.TOOL_VERSION }}-amd64.tar.gz
            
            # Install to container
            bash install.sh <ContainerID>
            ```
            
            ### âš™ï¸ Requirements
            
            - PVE 9.1+
            - Debian 13 (Trixie) container
            - amd64 architecture
            
          files: pve-toolkit-offline-v${{ env.TOOL_VERSION }}-amd64.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit versions.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/versions.json
          git commit -m "chore: update offline package version record" || echo "No changes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  skip:
    needs: check
    if: needs.check.outputs.should_build == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Skip notification
        run: |
          echo "âœ… All components are up to date, build skipped"
          echo ""
          echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.check.outputs.docker_ver }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compose | ${{ needs.check.outputs.compose_ver }} |" >> $GITHUB_STEP_SUMMARY
